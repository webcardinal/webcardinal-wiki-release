import{r as t,c as i,h as n,H as s}from"./p-bb51835b.js";import{d as a,D as o,s as e,F as l,m as r,n as h,o as c,r as d,q as u}from"./p-f5c9fd96.js";import{H as b}from"./p-5e0464e4.js";import{C as f}from"./p-0c675925.js";import{p}from"./p-f8a2682a.js";import"./p-e506992e.js";import{i as g,a as m,B as v}from"./p-3842b566.js";import"./p-8d1ed174.js";const w=class{constructor(s){t(this,s),this.getModelEvent=i(this,"webcardinal:model:get",7),this.getTranslationModelEvent=i(this,"webcardinal:translationModel:get",7),this.pageSize=0,this.pageSizeDelta=2,this.curentPageIndex=0,this.lastPageIndex=0,this.hidePagination=!1,this.useInfiniteScroll=!1,this.infiniteScrollPosition="bottom",this.useOptimisticMode=!1,this.loading=!1,this.childrenCount=0,this.bootConfig={hidePagination:!1},this.getTemplatesFromDOM=()=>{const t={header:[],data:[],loading:[]},i=Object.keys(t);for(const n of Array.from(this.host.childNodes))if(g(n))t.data.push(n);else if(m(n)){const s=n;if(!s.hasAttribute("slot")){t.data.push(s),this.childrenCount++;continue}if(i.includes(s.slot)){const{slot:i}=s;s.removeAttribute("slot"),s.classList.add(`webc-datatable--${i}`),t[i].push(s),this.childrenCount++}}return t},this.getDataSourceFromModel=async()=>{let{chain:t}=this;return t.startsWith(a)&&(t=t.substring(1)),(await p(this.getModelEvent)).getChainValue(t)},this.createDataTableWithPagination=()=>{const{header:t,data:i,loading:n}=this.getTemplatesFromDOM();t.forEach((t=>t.setAttribute(o,"")));const s=document.createElement("div");if(s.setAttribute("slot","data"),s.classList.add("webc-datatable--container"),s.setAttribute(e,`${this.childrenCount}`),s.setAttribute(l,`${a}data`),s.setAttribute(r,`${h}${this.useOptimisticMode?` ${c}`:""}`),void 0===this.gotoBottom&&(this.gotoBottom=this.useInfiniteScroll&&"top"===this.infiniteScrollPosition),s.addEventListener(d,(i=>{if(i.stopPropagation(),s.prepend(...t),!0===this.gotoBottom){let t;try{t=document.querySelector("ion-content")}catch(t){return void console.log(t)}t.scrollToBottom(),this.gotoBottom=!1}})),s.addEventListener(u,(t=>{t.stopPropagation()})),this.useInfiniteScroll)for(const t of n)t.remove();else{if(0===n.length){const t=this.createDefaultSpinner();t.style.position="relative",t.style.margin="0 auto",n.push(t)}for(const t of n)t.setAttribute("slot","loading"),s.append(t)}return s.append(...i),{dataTable:s,afterBindingCallback:()=>{t.forEach((t=>t.removeAttribute(o)));const i=document.createElement("div");i.append(...t),v.bindChildNodes(i,{model:this.model,translationModel:this.translationModel,recursive:!0,enableTranslations:!0}),s.prepend(...Array.from(i.childNodes))},loading:n}},this.createDataTableWithInfiniteScroll=()=>{if(!customElements.get("ion-infinite-scroll")||!customElements.get("ion-infinite-scroll-content"))return console.error(["For Infinit Scroll webc-datatable uses Ionic (v5)!","Please add Ionic distribution to your application!"].join("\n")),console.warn("Fallback to pagination mode for webc-datatable!"),this.createDataTableWithPagination();const{dataTable:t,afterBindingCallback:i,loading:n}=this.createDataTableWithPagination();t.removeAttribute("slot");const s=document.createElement("ion-content");s.style.setProperty("--background","transparent"),s.scrollY=!1,s.append(t);const a=document.createElement("div");a.classList.add("webc-datatable--scroll"),a.setAttribute("slot","data"),a.append(s);const o=i=>{i.stopPropagation(),t.removeEventListener(d,o),t.removeEventListener(u,o),s.scrollY=!0,window.requestAnimationFrame((()=>{s.style.height=`var(--height, ${t.scrollHeight}px)`}))};return t.addEventListener(d,o),t.addEventListener(u,o),{dataTable:a,afterBindingCallback:()=>{i();const a=document.createElement("ion-infinite-scroll-content");if(a.loadingSpinner=null,n.length>0){const t=document.createElement("div");t.append(...n),a.componentOnReady().then((()=>{a.firstElementChild.append(t)}))}else{const t=this.createDefaultSpinner();a.loadingText=t.outerHTML}this.infinitScroll=document.createElement("ion-infinite-scroll"),this.infinitScroll.setAttribute("position",this.infiniteScrollPosition),this.infinitScroll.classList.add("infinite-scroll-enabled","infinite-scroll-loading");let o=0;this.infinitScroll.addEventListener("ionInfinite",(async t=>{t.stopPropagation(),t.stopImmediatePropagation(),o++,await this.dataSource._renderPageAsync(o),window.requestAnimationFrame((()=>this.infinitScroll.complete()))})),this.infinitScroll.append(a),this.infinitScroll.componentOnReady().then((()=>{s.style.height=`var(--height, ${t.scrollHeight+this.infinitScroll.scrollHeight}px)`})),"top"===this.infiniteScrollPosition?s.prepend(this.infinitScroll):s.append(this.infinitScroll)}}},this.createDefaultSpinner=()=>{const t=document.createElement("webc-spinner");return t.classList.add("webc-datatable--loading"),t},this.createDefaultPagination=()=>{const t=this.curentPageIndex+1,i=this.lastPageIndex,s=[],a=function(t,i,n=2){const s=[],a=[];if(i<=1)return s;s.push(1);for(let a=t-n;a<=t+n;a++)a<i&&a>1&&s.push(a);let o;s.push(i);for(let t of s)o&&(t-o==2?a.push(o+1):t-o!=1&&a.push("...")),a.push(t),o=t;return a}(t,i,this.pageSizeDelta);for(const i of a)if("number"!=typeof i)"string"==typeof i&&s.push(i);else{if(i===t){s.push(n("button",{active:!0,part:"pagination-button pagination-button--active",disabled:!0},i));continue}s.push(n("button",{part:"pagination-button",onClick:()=>this.dataSource.goToPageByIndex(i-1)},i))}return 1!==i&&(s.unshift(n("button",{part:"pagination-button pagination-button--previous",disabled:1===t,onClick:()=>this.dataSource.goToPreviousPage()},"‹")),s.push(n("button",{part:"pagination-button pagination-button--next",disabled:t===i,onClick:()=>this.dataSource.goToNextPage()},"›"))),s},this.managePagination=()=>(this.model.pageNumbers={current:this.curentPageIndex+1,start:1,end:this.lastPageIndex},this.hidePagination||this.useInfiniteScroll?null:n("div",{part:"pagination",class:"pagination"},this.createDefaultPagination()))}async componentWillLoad(){if(!this.host.isConnected)return;this.bootConfig.hidePagination=this.hidePagination,this.dataSource=await this.getDataSourceFromModel(),this.translationModel=await p(this.getTranslationModelEvent);const{DataSource:t}=window.WebCardinal.dataSources;if(!(this.dataSource&&"object"==typeof this.dataSource&&this.dataSource instanceof t))return void console.error(`An invalid WebCardinal DataSource instance received: "${this.chain}"! [1]`,this.dataSource);try{this.model=await this.dataSource._init((()=>this.host))}catch(t){return console.error(`An invalid WebCardinal DataSource instance received: "${this.chain}"! [2]`,this.dataSource),void(this.dataSource=void 0)}this.host.classList.add("webc-datatable");const{dataTable:i,afterBindingCallback:n}=this.useInfiniteScroll?this.createDataTableWithInfiniteScroll():this.createDataTableWithPagination();this.host.append(i),v.bindChildNodes(this.host,{model:this.model,translationModel:this.translationModel,recursive:!0,enableTranslations:!0}),n(),this.listeners=new f(this.host,{model:this.model,translationModel:this.translationModel,chain:`${a}data`}),this.listeners.getModel.add(),this.listeners.getTranslationModel.add(),this.listeners.getParentChain.add()}async componentWillRender(){this.lastPageIndex=this.dataSize?Math.ceil(this.dataSize/this.pageSize):1}async connectedCallback(){if(this.listeners){const{getModel:t,getTranslationModel:i,getParentChain:n}=this.listeners;null==t||t.add(),null==i||i.add(),null==n||n.add()}}async disconnectedCallback(){if(this.listeners){const{getModel:t,getTranslationModel:i,getParentChain:n}=this.listeners;null==t||t.remove(),null==i||i.remove(),null==n||n.remove()}}async fillCurrentPage(t){const i=t=>this.host.shadowRoot.querySelector(`slot[name="${t}"]`),n=t=>{const n=i("before"),s=(t=>Object.assign(document.createElement("slot"),{name:t}))(t);return n.insertAdjacentElement("afterend",s),s};let s=i("data");const a=()=>{null==s||s.remove(),s=void 0,i("no-data")||n("no-data"),this.hidePagination=!0,this.model.data=[]},o=()=>{var t;s||(null===(t=i("no-data"))||void 0===t||t.remove(),s=n("data"))},e=(i=t)=>Array.isArray(i)&&0===i.length,l=()=>void 0===t;if(this.useInfiniteScroll)return e()&&e(this.model.data)?void a():e()&&this.infinitScroll?void(this.infinitScroll.disabled=!0):l()?void(this.model.data=void 0):(this.infinitScroll&&(this.infinitScroll.disabled=!1),o(),Array.isArray(this.model.data)||(this.model.data=[]),"top"===this.infiniteScrollPosition?this.model.data.unshift(...t):this.model.data.push(...t),"number"==typeof this.dataSize&&this.dataSize===this.model.data.length?void(this.infinitScroll&&(this.infinitScroll.disabled=!0)):void 0);e()?a():l()?this.model.data=void 0:(o(),Array.isArray(this.model.data)||(this.model.data=[]),this.bootConfig.hidePagination||(this.hidePagination=!1),this.model.data=t)}async clearCurrentPage(){this.model&&void 0!==this.model.data&&(this.model.data.length=0)}async pageSizeHandler(){var t;null===(t=this.dataSource)||void 0===t||t._renderPageAsync()}render(){return this.dataSource?n(s,null,n("slot",{name:"before"}),n("slot",{name:"data"}),this.managePagination(),n("slot",{name:"loading"}),n("slot",{name:"footer"}),n("slot",{name:"after"})):null}static get watchers(){return{pageSize:["pageSizeHandler"]}}};(function(t,i,n,s){var a,o=arguments.length,e=o<3?i:null===s?s=Object.getOwnPropertyDescriptor(i,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)e=Reflect.decorate(t,i,n,s);else for(var l=t.length-1;l>=0;l--)(a=t[l])&&(e=(o<3?a(e):o>3?a(i,n,e):a(i,n))||e);o>3&&e&&Object.defineProperty(i,n,e)})([b()],w.prototype,"host",void 0),w.style={default:":host .pagination{display:flex;gap:var(--pagination-gap);justify-content:center}:host .pagination>button{font-size:inherit;border:var(--pagination-button-border);background:var(--pagination-button-background)}:host .pagination>button:not([disabled]){cursor:pointer}:host .pagination>button[active]{color:inherit;font-weight:bold}"};export{w as webc_datatable}