import{r as t,c as i,h as n,H as a}from"./p-62bd51c0.js";import{C as s}from"./p-04a6fcf5.js";import{d as o,D as e,s as l,F as r,m as h,n as c,o as d,r as u,q as f}from"./p-f5c9fd96.js";import{H as b}from"./p-3e8e1274.js";import"./p-8d1ed174.js";import{p}from"./p-f8a2682a.js";import"./p-e506992e.js";import{i as g,a as m,B as v}from"./p-726637e7.js";const w=class{constructor(a){t(this,a),this.getModelEvent=i(this,"webcardinal:model:get",7),this.getTranslationModelEvent=i(this,"webcardinal:translationModel:get",7),this.pageSize=0,this.pageSizeDelta=2,this.curentPageIndex=0,this.lastPageIndex=0,this.hidePagination=!1,this.useInfiniteScroll=!1,this.useOptimisticMode=!1,this.loading=!1,this.childrenCount=0,this.bootConfig={hidePagination:!1},this.getTemplatesFromDOM=()=>{const t={header:[],data:[],loading:[]},i=Object.keys(t);for(const n of Array.from(this.host.childNodes))if(g(n))t.data.push(n);else if(m(n)){const a=n;if(!a.hasAttribute("slot")){t.data.push(a),this.childrenCount++;continue}if(i.includes(a.slot)){const{slot:i}=a;a.removeAttribute("slot"),a.classList.add("webc-datatable--"+i),t[i].push(a),this.childrenCount++}}return t},this.getDataSourceFromModel=async()=>{let{chain:t}=this;return t.startsWith(o)&&(t=t.substring(1)),(await p(this.getModelEvent)).getChainValue(t)},this.createDataTableWithPagination=()=>{const{header:t,data:i,loading:n}=this.getTemplatesFromDOM();t.forEach((t=>t.setAttribute(e,"")));const a=document.createElement("div");if(a.setAttribute("slot","data"),a.classList.add("webc-datatable--container"),a.setAttribute(l,""+this.childrenCount),a.setAttribute(r,o+"data"),a.setAttribute(h,`${c}${this.useOptimisticMode?" "+d:""}`),a.addEventListener(u,(i=>{i.stopPropagation(),a.prepend(...t)})),a.addEventListener(f,(t=>{t.stopPropagation()})),this.useInfiniteScroll)for(const t of n)t.remove();else{if(0===n.length){const t=this.createDefaultSpinner();t.style.position="relative",t.style.margin="0 auto",n.push(t)}for(const t of n)t.setAttribute("slot","loading"),a.append(t)}return a.append(...i),{dataTable:a,afterBindingCallback:()=>{t.forEach((t=>t.removeAttribute(e)));const i=document.createElement("div");i.append(...t),v.bindChildNodes(i,{model:this.model,translationModel:this.translationModel,recursive:!0,enableTranslations:!0}),a.prepend(...Array.from(i.childNodes))},loading:n}},this.createDataTableWithInfiniteScroll=()=>{if(!customElements.get("ion-infinite-scroll")||!customElements.get("ion-infinite-scroll-content"))return console.error(["For Infinit Scroll webc-datatable uses Ionic (v5)!","Please add Ionic distribution to your application!"].join("\n")),console.warn("Fallback to pagination mode for webc-datatable!"),this.createDataTableWithPagination();const{dataTable:t,afterBindingCallback:i,loading:n}=this.createDataTableWithPagination();t.removeAttribute("slot");const a=document.createElement("ion-content");a.style.setProperty("--background","transparent"),a.scrollY=!1,a.append(t);const s=document.createElement("div");s.classList.add("webc-datatable--scroll"),s.setAttribute("slot","data"),s.append(a);const o=i=>{i.stopPropagation(),t.removeEventListener(u,o),t.removeEventListener(f,o),a.scrollY=!0,window.requestAnimationFrame((()=>{a.style.height=`var(--height, ${t.scrollHeight}px)`}))};return t.addEventListener(u,o),t.addEventListener(f,o),{dataTable:s,afterBindingCallback:()=>{i();const s=document.createElement("ion-infinite-scroll-content");if(s.loadingSpinner=null,n.length>0){const t=document.createElement("div");t.append(...n),s.componentOnReady().then((()=>{s.firstElementChild.append(t)}))}else{const t=this.createDefaultSpinner();s.loadingText=t.outerHTML}this.infinitScroll=document.createElement("ion-infinite-scroll"),this.infinitScroll.classList.add("infinite-scroll-enabled","infinite-scroll-loading");let o=0;this.infinitScroll.addEventListener("ionInfinite",(async t=>{t.stopPropagation(),t.stopImmediatePropagation(),o++,await this.dataSource._renderPageAsync(o),window.requestAnimationFrame((()=>this.infinitScroll.complete()))})),this.infinitScroll.append(s),this.infinitScroll.componentOnReady().then((()=>{a.style.height=`var(--height, ${t.scrollHeight+this.infinitScroll.scrollHeight}px)`})),a.append(this.infinitScroll)}}},this.createDefaultSpinner=()=>{const t=document.createElement("webc-spinner");return t.classList.add("webc-datatable--loading"),t},this.createDefaultPagination=()=>{const t=this.curentPageIndex+1,i=this.lastPageIndex,a=[],s=function(t,i,n=2){const a=[],s=[];if(i<=1)return a;a.push(1);for(let s=t-n;s<=t+n;s++)s<i&&s>1&&a.push(s);let o;a.push(i);for(let t of a)o&&(t-o==2?s.push(o+1):t-o!=1&&s.push("...")),s.push(t),o=t;return s}(t,i,this.pageSizeDelta);for(const i of s)if("number"!=typeof i)"string"==typeof i&&a.push(i);else{if(i===t){a.push(n("button",{active:!0,part:"pagination-button pagination-button--active",disabled:!0},i));continue}a.push(n("button",{part:"pagination-button",onClick:()=>this.dataSource.goToPageByIndex(i-1)},i))}return 1!==i&&(a.unshift(n("button",{part:"pagination-button pagination-button--previous",disabled:1===t,onClick:()=>this.dataSource.goToPreviousPage()},"‹")),a.push(n("button",{part:"pagination-button pagination-button--next",disabled:t===i,onClick:()=>this.dataSource.goToNextPage()},"›"))),a},this.managePagination=()=>(this.model.pageNumbers={current:this.curentPageIndex+1,start:1,end:this.lastPageIndex},this.hidePagination||this.useInfiniteScroll?null:n("div",{part:"pagination",class:"pagination"},this.createDefaultPagination()))}async componentWillLoad(){if(!this.host.isConnected)return;this.bootConfig.hidePagination=this.hidePagination,this.dataSource=await this.getDataSourceFromModel(),this.translationModel=await p(this.getTranslationModelEvent);const{DataSource:t}=window.WebCardinal.dataSources;if(!(this.dataSource&&"object"==typeof this.dataSource&&this.dataSource instanceof t))return void console.error(`An invalid WebCardinal DataSource instance received: "${this.chain}"! [1]`,this.dataSource);try{this.model=await this.dataSource._init((()=>this.host))}catch(t){return console.error(`An invalid WebCardinal DataSource instance received: "${this.chain}"! [2]`,this.dataSource),void(this.dataSource=void 0)}this.host.classList.add("webc-datatable");const{dataTable:i,afterBindingCallback:n}=this.useInfiniteScroll?this.createDataTableWithInfiniteScroll():this.createDataTableWithPagination();this.host.append(i),v.bindChildNodes(this.host,{model:this.model,translationModel:this.translationModel,recursive:!0,enableTranslations:!0}),n(),this.listeners=new s(this.host,{model:this.model,translationModel:this.translationModel,chain:o+"data"}),this.listeners.getModel.add(),this.listeners.getTranslationModel.add(),this.listeners.getParentChain.add()}async componentWillRender(){this.lastPageIndex=this.dataSize?Math.ceil(this.dataSize/this.pageSize):1}async connectedCallback(){if(this.listeners){const{getModel:t,getTranslationModel:i,getParentChain:n}=this.listeners;null==t||t.add(),null==i||i.add(),null==n||n.add()}}async disconnectedCallback(){if(this.listeners){const{getModel:t,getTranslationModel:i,getParentChain:n}=this.listeners;null==t||t.remove(),null==i||i.remove(),null==n||n.remove()}}async fillCurrentPage(t){const i=t=>this.host.shadowRoot.querySelector(`slot[name="${t}"]`),n=t=>{const n=i("before"),a=(t=>Object.assign(document.createElement("slot"),{name:t}))(t);return n.insertAdjacentElement("afterend",a),a};let a=i("data");const s=()=>{null==a||a.remove(),a=void 0,i("no-data")||n("no-data"),this.hidePagination=!0,this.model.data=[]},o=()=>{var t;a||(null===(t=i("no-data"))||void 0===t||t.remove(),a=n("data"))},e=(i=t)=>Array.isArray(i)&&0===i.length,l=()=>void 0===t;if(this.useInfiniteScroll)return e()&&e(this.model.data)?void s():e()?void(this.infinitScroll.disabled=!0):l()?void(this.model.data=void 0):(this.infinitScroll.disabled=!1,o(),Array.isArray(this.model.data)||(this.model.data=[]),this.model.data.push(...t),"number"==typeof this.dataSize&&this.dataSize===this.model.data.length?void(this.infinitScroll.disabled=!0):void 0);e()?s():l()?this.model.data=void 0:(o(),Array.isArray(this.model.data)||(this.model.data=[]),this.bootConfig.hidePagination||(this.hidePagination=!1),this.model.data=t)}async clearCurrentPage(){this.model&&void 0!==this.model.data&&(this.model.data.length=0)}async pageSizeHandler(){var t;null===(t=this.dataSource)||void 0===t||t._renderPageAsync()}render(){return this.dataSource?n(a,null,n("slot",{name:"before"}),n("slot",{name:"data"}),this.managePagination(),n("slot",{name:"loading"}),n("slot",{name:"footer"}),n("slot",{name:"after"})):null}static get watchers(){return{pageSize:["pageSizeHandler"]}}};(function(t,i,n,a){var s,o=arguments.length,e=o<3?i:null===a?a=Object.getOwnPropertyDescriptor(i,n):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)e=Reflect.decorate(t,i,n,a);else for(var l=t.length-1;l>=0;l--)(s=t[l])&&(e=(o<3?s(e):o>3?s(i,n,e):s(i,n))||e);o>3&&e&&Object.defineProperty(i,n,e)})([b()],w.prototype,"host",void 0),w.style={default:":host .pagination{display:flex;gap:var(--pagination-gap);justify-content:center}:host .pagination>button{font-size:inherit;border:var(--pagination-button-border);background:var(--pagination-button-background)}:host .pagination>button:not([disabled]){cursor:pointer}:host .pagination>button[active]{color:inherit;font-weight:bold}"};export{w as webc_datatable}